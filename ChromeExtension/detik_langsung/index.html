<html><script>
console.log("BG!");
var cached_title_url = new Array();
var pt1 = /^\s\s*/;
var pt2 = /\s\s*$/;

chrome.extension.onRequest.addListener(
function(request, sender, senderResponse) {
    console.log("Receive:" + request.cmd);
    if (request.cmd == "INCSKIP") {
        increment_skiped_count();
        senderResponse({});
    }
    else if (request.cmd == "SOLVE") {
        var title = request.title;
        var href = request.href;
        if (cached_title_url[title] == undefined) {
            //query webpage, iterate it's title
            console.log("Req:" + href);
            var xhr = new XMLHttpRequest();
            xhr.open("GET", href, false);
            xhr.send();
            
            //use temporary div trick to parse DOM
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = xhr.responseText;
            anchors = tempDiv.getElementsByTagName("a");
            
            var found = false;
            for (var i = 0; i < anchors.length; i++) {
                var el = anchors[i];
                if (el.href.indexOf("/read/") > -1) {
                    cached_title_url[el.innerText.replace(pt1, '').replace(pt2, '')] = el.href;
                }
                if (found) continue;
                if (el.innerText.indexOf(title) ==  -1) continue;
                if (el.protocol == "widget:") {
                    //fix relative url, use anchor object to help me parse url
                    var a = document.createElement("a");
                    a.href = href;
                    el.protocol = a.protocol;
                    el.hostname = a.hostname;
                    el.port = a.port;
                }
                href = el.href;
                increment_skiped_count();
                found = true;
            }
        }
        else {
            href = cached_title_url[title];
            console.log("From cache:" + href);
        }
        
        senderResponse({cmd:"REDIRECT", href:href});
    }
    else if (request.cmd == "INIT") {
        if (localStorage["skipped_count"] == undefined) {
            localStorage["skipped_count"] = 0;
        }
        console.log("Count: " + localStorage["skipped_count"]);
        var skipped_count = parseInt(localStorage["skipped_count"]) + 1;
        senderResponse({cmd:"COUNT", skipped_count:skipped_count});
    }
});

function increment_skiped_count() {
    localStorage["skipped_count"] = parseInt(localStorage["skipped_count"]) + 1;
}

</script></html>