<!doctype html>
<html lang="en"><head><script>
var cached_title_url = new Array();
var pt1 = /^\s\s*/;
var pt2 = /\s\s*$/;

opera.extension.onmessage = function(event) {
    var request = JSON.parse(event.data)
    if (request.cmd == "INCSKIP") {
        increment_skiped_count();
    }
    else if (request.cmd == "SOLVE") {
        var title = request.title;
        var href = request.href;
        if (cached_title_url[title] == undefined) {
            //query webpage, iterate it's title
            var xhr = new XMLHttpRequest();
            xhr.open("GET", href, false);
            xhr.send();
            
            //use temporary div trick to parse DOM
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = xhr.responseText;
            anchors = tempDiv.getElementsByTagName("a");

            var found = false;
            for (var i = 0; i < anchors.length; i++) {
                var el = anchors[i];
                if (el.href.indexOf("/read/") > -1) {
                    cached_title_url[el.innerText.replace(pt1, '').replace(pt2, '')] = el.href;
                }
                if (found) continue;
                if (el.innerText.indexOf(title) ==  -1) continue;
                if (el.protocol == "widget:") {
                    //fix relative url, use anchor object to help me parse url
                    var a = document.createElement("a");
                    a.href = href;
                    el.protocol = a.protocol;
                    el.hostname = a.hostname;
                    el.port = a.port;
                }
                href = el.href;
                increment_skiped_count();
                found = true;
            }
        }
        else {
            href = cached_title_url[title];
            opera.postError("From cache:" + href);
        }
        event.source.postMessage(JSON.stringify({cmd:"REDIRECT", href:href}));
    }
    else if (request.cmd == "INIT") {
        if (widget.preferences["skipped_count"] == undefined) {
            widget.preferences["skipped_count"] = 0;
        }
        opera.postError("Count: " + widget.preferences["skipped_count"]);
        var skipped_count = parseInt(widget.preferences["skipped_count"]) + 1;
        event.source.postMessage(JSON.stringify({cmd:"COUNT", skipped_count:skipped_count}));
    }
}

function increment_skiped_count() {
    widget.preferences["skipped_count"] = parseInt(widget.preferences["skipped_count"]) + 1;
}

</script></head><body></body></html>